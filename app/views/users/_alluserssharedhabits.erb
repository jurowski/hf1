<% 
begin
%>
  <h1>Shared Habits</h1>
  <i>Goals that other members have chosen to share their progress on.</i>
  <br />
    <img src='/images/img08.jpg'>		
  <%

  if current_user
    @goals = Goal.find(:all, :conditions => "user_id <> '#{current_user.id}' and status <> 'hold' and publish = '1'") 
  else
    @goals = Goal.find(:all, :conditions => "status <> 'hold' and publish = '1'")   
  end
  ### GET DATE NOW ###
  jump_forward_days = 0
  tnow = Time.now
  tnow_Y = tnow.strftime("%Y").to_i #year, 4 digits
  tnow_m = tnow.strftime("%m").to_i #month of the year
  tnow_d = tnow.strftime("%d").to_i #day of the month
  tnow_H = tnow.strftime("%H").to_i #hour (24-hour format)
  tnow_M = tnow.strftime("%M").to_i #minute of the hour
  #puts tnow_Y + tnow_m + tnow_d  
  #puts "Current timestamp is #{tnow.to_s}"
  dnow = Date.new(tnow_Y, tnow_m, tnow_d) + jump_forward_days
  ######

  @goals.each do |goal|

    daysgoneby = dnow - goal.start
    daysleft = goal.stop - dnow
    @checkpoints = Checkpoint.find(:all, :conditions => "goal_id = '#{goal.id}'")
    totalsize = @checkpoints.size
    %>









    <br>
    <strong><%= goal.user.first_name %> is... </strong><%= goal.response_question %>&nbsp;
    <%
    if goal.status == "start"
      @checkpoints_missing = Checkpoint.find(:all, :conditions => "goal_id = '#{goal.id}' and checkin_date >= '#{goal.start}' and checkin_date <= '#{goal.stop}' and status = 'email sent'")
    end    
    %>



    <% 
    if goal.status == "start"
      ### If we've established the goal, ask if they want it monitored
      if goal.established_on > goal.start
      else
        if @checkpoints_missing.size > 1
        else
        %>
          <br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <%= daysgoneby %> days down, 
          <%= daysleft %> days to go! 
        <%
        end
      end
    end
    %>  


    <% if totalsize > 0 %>
      <%
      @no = Checkpoint.find(:all, :conditions => "status = 'no' and goal_id = '#{goal.id}'")
      %>
      <% no_percent = (((@no.size + 0.0) / totalsize)*100).floor  %>
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <strong> 
      <%
      @yes = Checkpoint.find(:all, :conditions => "status = 'yes' and goal_id = '#{goal.id}'")
      %>
      <% yes_percent = (((@yes.size + 0.0) / totalsize)*100).floor %>
      <%= yes_percent%>% success</strong>
      </br>
       (<%= @yes.size %> yes, 

      <%= @no.size %> no, 
      <%
      @missing = Checkpoint.find(:all, :conditions => "status = 'email sent' and goal_id = '#{goal.id}'")
      %>
      <% 
      # Convert these Ints into Floats by adding 0.0
      missing = @missing.size + 0.0
      total = totalsize + 0.0
      missing_percent = ((missing / total)*100).floor
      %>
      <%= @missing.size %> no reply)

      <%
      if @checkpoints_missing.size > 1
        #<img src="/images/question.png" alt="Missing checkpoints" width = 25/>
      else
        %>
        <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/images/ring_buttons<%= daysgoneby %>.png" alt="<%= daysgoneby %> days in a row" width = 35/>
        <br>
        <%
      end
      %>
    <% else %>
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <strong>no stats yet</strong>
    <% end %>


    <br />
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <% end %>

  <br />

<%
rescue
%>
  <br>
  <p>Something went wrong. Go back to the <a href="http://habitforge.com">home page</a> and try again, or <a href="mailto:support@habitforge.com">Contact Support</a></p>
<%
end
%>  

