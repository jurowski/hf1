<form>
  <input type="textbox" name="search_for">
  <input type="submit" name="find" value="Find">
</form>
<h1>Listing <%= @users.size %> users</h1>

<%
counter_last_3_days = 0
counter_last_3_days_yes = 0
counter_last_3_days_no = 0
counter_goals_no_checkins = 0
counter_no_goals = 0
counter_have_goals = 0
%>
<% @users.each do |user| %>
    <hr>
    <h2><%= user.name %></h2>
    Member Since <%=h user.created_at.strftime("%Y-%m-%d") %>
    <HR>
    <%
    if session[:current_user_is_admin] == true
    %>
        <a href="mailto:<%=user.email%>"><%=user.email%></a> 

        <%= link_to 'Delete', user, :confirm => 'Delete '+user.email+', goals and stats?', :method => :delete %>

        <%= link_to user.id.to_s, edit_user_path(user) %>
        <br>
        <a href="users?impersonate=<%=user.id%>" class="btn">Impersonate</a>

         <% if !user.confirmed_address %>

              <a href="users?confirm_id=<%=user.id%>" class="btn">Confirm Account</a>

        <% end %>
        <br>

        <% if user.unsubscribed_from_promo_emails == 1 %>
            UNSUBSCRIBED FROM PROMO EMAILS
        <% else %>
            <a href="/users?unsubscribe=<%= user.id.to_s %>&first_name=<%= user.first_name%>" class="btn">Unsubscribe from Promo Emails</a>
        <% end %>

         <br>
        <% if session[:sponsor] == "habitforge" %>

                <% if user.plan %>
                    <strong>Current Plan: </strong><mark><%= user.plan %></mark>
                <% end %>
                <% if user.kill_ads_until %>
                    <% if user.kill_ads_until.to_s == "3000-01-01" %>
                        <mark>ONGOING</mark>
                    <% else %>
                        <% if user.kill_ads_until.to_s == "1900-01-01"%>
                            <mark>NEVER UPGRADED</mark>
                        <% else %>
                            <mark>THROUGH <%= user.kill_ads_until %></mark>
                        <% end %>
                    <% end %>

                    <div>
                    <h3>DOWNGRADE OPTIONS</h3>
                    <a href="users?downgrade_id=<%=user.id%>&when=today" class="btn">Set Downgrade to Today</a> 
                    </div>


                <% end %>
                <br>
                <strong>
                <% if user.supportpoints %>
                    SUPPORT POINTS:</strong> <mark><%= user.supportpoints %></mark>
                <% else %>
                    SUPPORT POINTS:</strong> <mark>NONE</mark>
                <% end %>

                <br>
                <% if user.got_free_membership %>
                <br> 
                    (free membership given on <%= user.got_free_membership.to_s %>)
                <% else %>
                    <% if user.id > 85758 %>
                      <a href="users?use_support_points=1&days=90&upgrade_id=<%=user.id%>" class="btn">trade 100pts for 3 mos</a>
                    <% else %>
                      <a href="users?use_support_points=1&days=365&upgrade_id=<%=user.id%>" class="btn">trade 100pts for 1 yr</a>
                    <% end %>
                <% end %>

                <div>
                    <h3>Full Price</h3>
                    <a href="users?days=3000&plan=monthly-295&upgrade_id=<%=user.id%>" class="btn">$2.95 monthly</a>
 
                   <a href="users?days=3000&plan=yearly-2395&upgrade_id=<%=user.id%>" class="btn">$23.95 yearly</a>
              </div>

                <div>
                    <h3>Discounted 30%</h3>
                <br>
                  <a href="users?days=3000&plan=monthly-295&upgrade_id=<%=user.id%>&coupon=30" class="btn">$2.95 monthly 30% OFF</a>

                   <a href="users?days=3000&plan=yearly-2395&upgrade_id=<%=user.id%>&coupon=30" class="btn">$23.95 yearly 30% OFF</a>

                </div>

                <div>
                    <h3>Discounted 40%</h3>
                <br>
                  <a href="users?days=3000&plan=monthly-295&upgrade_id=<%=user.id%>&coupon=40" class="btn">$2.95 monthly 40% OFF</a>

                   <a href="users?days=3000&plan=yearly-2395&upgrade_id=<%=user.id%>&coupon=40" class="btn">$23.95 yearly 40% OFF</a>

                </div>


                <div>
                    <h3>Discounted 50%</h3>
                <br>
                  <a href="users?days=3000&plan=monthly-295&upgrade_id=<%=user.id%>&coupon=50" class="btn">$2.95 monthly 50% OFF</a>
 
                   <a href="users?days=3000&plan=yearly-2395&upgrade_id=<%=user.id%>&coupon=50" class="btn">$23.95 yearly 50% OFF</a>
              </div>

                <div>
                    <h3>Discounted 60%</h3>

                  <a href="users?days=3000&plan=monthly-295&upgrade_id=<%=user.id%>&coupon=60" class="btn">$2.95 monthly 60% OFF</a>

                  <a href="users?days=3000&plan=yearly-2395&upgrade_id=<%=user.id%>&coupon=60" class="btn">$23.95 yearly 60% OFF</a>
              </div>

                <div>
                    <h3>Old Deals</h3>
                  <a href="users?days=3000&plan=monthly-1-29&upgrade_id=<%=user.id%>" class="btn">$1.29 monthly</a>
                </div>


        <% end %>
         <br>

    <%
    end
    %>
    <%
    dnow = get_dnow
    latest_date = ""
    latest_status = ""
    goals_number = 0
    goal_conditions = "user_id = #{user.id}"
    goal_conditions = goal_conditions + " and status != 'hold'"
    @goals = Goal.find(:all, :conditions => goal_conditions)
    for goal in @goals
        goals_number = goals_number + 1
        if goal.laststatusdate != nil and goal.laststatus != nil
            if latest_date == ""
                latest_date = goal.laststatusdate
                latest_status = goal.laststatus
            else
                if goal.laststatusdate > latest_date
                    latest_date = goal.laststatusdate
                    latest_status = goal.laststatus
                end
            end
        end
    end    
    if goals_number > 0
        if latest_date != ""
            lag_time = dnow - latest_date
            if lag_time > 3
                %>
                <font color=gray>(Last checkin was a "<%= latest_status %>" on <%= latest_date %>)</font>  
                <%
            else
                counter_last_3_days = counter_last_3_days + 1
                %>
                <font color=green>(Last checkin was a "<%= latest_status %>" on <%= latest_date %>)</font>  
                <%                
                if latest_status == "yes"
                    counter_last_3_days_yes = counter_last_3_days_yes + 1
                end
                if latest_status == "no"
                    counter_last_3_days_no = counter_last_3_days_no + 1
                end
            end
        else
            counter_goals_no_checkins = counter_goals_no_checkins + 1
            %>
            <font=red>Goals, but no "yes/no" checkins</font>
            <%
        end
        counter_have_goals = counter_have_goals + 1
    else
        counter_no_goals = counter_no_goals + 1
        %>
        <font=red>No goals</font>
        <%
    end
    %>    
    <br>
    <hr>
    <HR>
<% end %>
<hr>
<strong>TOTALS</strong>
<hr>
<br><%= counter_have_goals %> people have goals.
<br><%= counter_no_goals %> people do not have goals entered.
<br><%= counter_goals_no_checkins %> people have goals but never checked in with a "yes" or "no".
<hr>
<br>Of the <%= counter_last_3_days %> people who checked in during the last 3 days, 
<%= counter_last_3_days_yes %> said "YES" and <%= counter_last_3_days_no %> said "NO".
<hr>

<br />

