
<%
if session[:sponsor] == nil or session[:sponsor] == "" or session[:sponsor] == "habitforge"
  session[:site_name] = "habitforge"
  session[:support_email] = "support@habitforge.com"
end
if request.domain.include? 'mylearninghabit' or session[:sponsor] == "clearworth"
	session[:site_name] = "My Learning Habit"
  session[:support_email] = "support@habitforge.com"
end
if request.domain.include? 'forittobe' or session[:sponsor] == "forittobe"
	session[:site_name] = "For It To Be"
  session[:support_email] = "support@forittobe.com"	
end
if request.domain.include? 'marriagereminders' or session[:sponsor] == "marriagereminders"
	session[:site_name] = "Marriage Reminders"
  session[:support_email] = "support@marriagereminders.com"	
end


### GET DATE NOW ###
jump_forward_days = 0


if current_user or @checkpoint.goal
  Time.zone = @checkpoint.goal.user.time_zone
  tnow = Time.zone.now #User time
else
  tnow = Time.now
end


tnow_Y = tnow.strftime("%Y").to_i #year, 4 digits
tnow_m = tnow.strftime("%m").to_i #month of the year
tnow_d = tnow.strftime("%d").to_i #day of the month
tnow_H = tnow.strftime("%H").to_i #hour (24-hour format)
tnow_M = tnow.strftime("%M").to_i #minute of the hour
dnow = Date.new(tnow_Y, tnow_m, tnow_d) + jump_forward_days
dyesterday = dnow - 1
d3days_ago = dnow - 3
d10days_ago = dnow - 10
######




################################################
####### WHAT PAGES SHOULD WE RETURN TO?
session[:current_page] = request.request_uri
session[:return_to_me] = request.request_uri
################################################



########################
#### LEGIT URL?
########################
#### for any checkpoint created after 20091130 at 12 midnight (id of 14789 or greater), require goal id and user id in the params
if @checkpoint.id > 14789 and (params[:u] != @checkpoint.goal.user.id.to_s or params[:g] != @checkpoint.goal.id.to_s)
  ###fail, may be a fraudulent URL
  legit_url = 0
  %>
  Data is missing. This checkpoint will not be saved.
  <%
else
  legit_url = 1
end
########################
#### END LEGIT URL?
########################
%>


<%
if legit_url == 1
  ########################################################
  ############ SHOW CATEGORY WINNNERS FOR YESTERDAY ##### 
  ########################################################
  if params[:show_winners] 
  %>
    <%= render :partial => "checkpoints/priordaycategorywinners.erb", :locals => { :priordaycategorywinners => @checkpoints }  %>
    <% #will render the partial _priordaycategorywinners.erb file from the checkpoints views %>      
  <% 
  ########################################################
  ############## END SHOW CATEGORY WINNERS FOR YESTERDAY
  ########################################################
  else 
  %>





    <% 
    ########################################
    ###### PRINT WELCOME INFO ##########
    ########################################
    
    if @checkpoint.status == "yes"
        arr_congrats = Array.new
        arr_congrats.push(["Keep up the good work with xxx! The more you succeed, the easier it becomes!"])
        arr_congrats.push(["Hey, you kept your word about xxx! Good job!"])
        arr_congrats.push(["Winning is pretty cool, isn't it? Keep up the great work with your xxx goal!"])
        arr_congrats.push(["Kudos to you for following through with your xxx goal!"])
        arr_congrats.push(["How's it feel to put a notch in the success column? You achieved your xxx goal!"])
        arr_congrats.push(["Hey, great job with your xxx goal!"])
        arr_congrats.push(["You did it! Nice job with xxx !"])
        arr_congrats.push(["Alright, a successful day! Keep up the good work with your daily goal of xxx !"])


        random_number = 0
        random_number = rand(arr_congrats.size) + 0 #between 0 and arr_congrats.size
        random_congrats = arr_congrats[random_number]
        congrats = random_congrats.to_s
        congrats = congrats.sub("xxx","''" + @checkpoint.goal.title + "''")

        %>
        <div class="success" style="width:800px;">
            <h2><%= congrats %></h2>
            (that was <%= @checkpoint.checkin_date.strftime("%A") %>'s check-in)
        </div>
    <% else %>

        <%
        arr_sorry = Array.new
        arr_sorry.push(["Sorry you weren't successful at your xxx goal."])

        random_number = 0
        random_number = rand(arr_sorry.size) + 0 #between 0 and arr_sorry.size
        random_sorry = arr_sorry[random_number]
        sorry = random_sorry.to_s
        sorry = sorry.sub("xxx","''" + @checkpoint.goal.title + "''")

        %>

      <div class="error" style="width:800px;">
        <h2><%= sorry %></h2>
        (that was <%= @checkpoint.checkin_date.strftime("%A") %>'s check-in)
      </div>

    <% end %>

    <% if params[:return_to_url] %>
      <p>
      <a href="<%= params[:return_to_url] %>"><-- Go Back</a>      
      </p>
    <% end %>
    



    <!--
    ##########################
    START ADD NEW GOAL SECTION
    ##########################
    -->
    <%
    ### Let's only show this if they're coming from email check-in, and if they're potential customers
    if current_user == nil

      active_goal_limit = 1

      @my_start_goals = Goal.find(:all, :conditions => "user_id = '#{@checkpoint.goal.user.id}' and status = 'start' and established_on = '1900-01-01'") 
      @my_monitor_goals = Goal.find(:all, :conditions => "user_id = '#{@checkpoint.goal.user.id}' and status = 'monitor'") 
      my_active_goals_size = @my_monitor_goals.size + @my_start_goals.size

      if ((my_active_goals_size > (active_goal_limit - 1)) and (@checkpoint.goal.user.unlimited_goals != 1) and (session[:site_name] == "habitforge"))
        %>
            <h3><%= link_to_function ('<img src="/images/add_32.png" border="0" />Start a New Habit ("Go Unlimited" for as little as $2.95!)') {
             |page| page.visual_effect :toggle_appear, "advanced" 
            }%></h3>
            <div id="advanced" style="display:none;">




                    <div class="success">
                        <strong>Your account is currently restricted to one active habit at a time...</strong>
                        <h3>Get a full year of Unlimited Active Habits, ad-free, with a Premium Membership!</h3>
                    </div> 



                    <h3>HabitForge has been recommended in these books and magazines:</h3>
                    <div style="border-radius:20px;-moz-border-radius:20px;border-width:medium;border-color:#eeeeee;background-color:#ffffff;border-style:solid;padding:10px 10px 10px 25px;margin:10px 10px 10px 10px;width:610px;">
                      <div style="text-align: left; color: rgb(68, 68, 68);">
                        <h4><a href="http://www.fourhourbody.com/">The 4-Hour Body</a>&nbsp;(Amazon #1 Best-Seller by Tim Ferriss)<br />
                        <a href="http://peakperformancelifestyle.com/2011/08/15/power-of-positive-fitness/">
                        The Power of Positive Fitness*</a>&nbsp;(Best-Selling Author John Rowley)<br />
                        Family Circle (<a href="http://www.familycircle.com/family-fun/technology/online-tools-for-achieving-goals/">online article</a> + Jan. 2011 Print Issue)<br />
                        Woman's Day <a href="http://www.womansday.com/Articles/Health-Fitness/Make-Healthy-Habits-Stick.html">(online article</a>&nbsp;+ Nov. 2010 Print Issue)<br />
                        PC World <a href="http://tech.ca.msn.com/pcworld-article.aspx?cp-documentid=23549978">(online article)</a><br />
                        Martha Stewart's Radio Blog (Sirius w/ John Rowley, October 2011 broadcast)*</h4>
                        <div><h5>*(HabitFoundry, based on the HabitForge app)</h5></div>
                      </div>  
                      </div>


                        <br><h3><a href="https://www.securepublications.com/habit-1-year.php?ref=<%= @checkpoint.goal.user.id.to_s %>" class="start_now">Learn More</a></h3>
<p><%= link_to_function ("Not now, thanks") {
             |page| page.visual_effect :toggle_appear, "advanced" 
            }%></p>                        
                      <p />
                      <p />
                      <p />
                      <p />


            </div>
        <%
        end

    end
    %>
    <!--
    ##########################
    END ADD NEW GOAL SECTION
    ##########################
    -->


    <!-- 
    COACH!!!
    START render the partial _coach.erb file from the goal views 
      @goal = @checkpoint.goal
      render :partial => "goals/coach", :locals => { :coach => @goal }
      <br>
      <br>
    END render the partial _coach.erb file from the goal views 
    -->
    
    
    
    <!-- 
    FIRE!!!
    START render the partial _fire.erb file from the goal views 
    -->
      <% @goal = @checkpoint.goal %>
      <%= render :partial => "goals/fire", :locals => { :fire => @goal }  %>
      <br>
      <br>
    <!-- 
    END render the partial _fire.erb file from the goal views 
    -->
    
    <br />





    <% goal = @checkpoint.goal %>

    <!--
    ########################
    START TEAM SECTION
    ########################
    -->
    <DIV style="border-radius:20px;-moz-border-radius:20px;border-width:none;border-color:#eeeeee;background-color:#ffffff;border-style:solid;padding:10px 10px 10px 25px;margin:10px 10px 10px 10px;width:610px;">
    <p>                
        <!-- START Team Section -->
        
        <% if goal.team != nil %>  
            <%
              @team_goals = Goal.find(:all, :conditions => "team_id = '#{goal.team_id}'")
              if @team_goals.size < 2
                  %>
                  <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />We're recruiting other people for your team.
                  </h3></p>
                  <br>
                  <%
              else
                  has_percentage = 0
                  total_percentage = 0
                  average_percentage = 0
                  for team_goal in @team_goals
                      if team_goal.success_rate_percentage != nil
                          has_percentage = has_percentage + 1
                          total_percentage = total_percentage + team_goal.success_rate_percentage
                      end
                  end
                  if has_percentage > 0
                      average_percentage = total_percentage / has_percentage
                      %>
                      <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />My Team's Success Rate is <%= average_percentage %>% 
                      
                      | <a href="popupex.html" onclick="return popitup('/team_rules.html')">Team Rules</a>
                      </h3></p>
                      <br>
                      <%
                  else
                      %>
                      <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />My Team</h3></p>
                      <br>
                      <%                  
                  end
              end
              for team_goal in @team_goals
                %>
                <% if team_goal.user.id != @checkpoint.goal.user.id %>
                    <p><img src="/images/comment_user_add_32.png" border=0 />
                    <% if current_user == nil %>
                         <a href="/user_session/new?skip_intro=1&after_login_cn=tomessages&after_login_ca=new&after_login_param_1_name=to_id&after_login_param_1_val=<%= team_goal.user.id %>" >
                    <% else %>
                         <a href="/tomessages/new?to_id=<%= team_goal.user.id %>" >
                    <% end %>
                    Send <%= team_goal.user.first_name %> a Message about <%= team_goal.response_question %></a>
                    â€¢ 
                    <% if team_goal.success_rate_percentage != nil %>
                         Succeeding <%= team_goal.success_rate_percentage %>% of the last
                    <% end %>
                    <% if team_goal.days_into_it != nil %>
                        <%= team_goal.days_into_it %> days
                    <% end %>

                    <% if team_goal.daysstraight != nil and team_goal.daysstraight != 9999 %>
                        has done it <%= team_goal.daysstraight %> days in a row
                    <% end %>

                    <% if team_goal.laststatusdate != nil and team_goal.laststatus != nil %>
                    <% else %>              
                         (has not yet checked in)
                    <% end %> 
                    </p>
                <% end %>            
                <%
              end
            %> 
        <% end %>

        <% if goal.team == nil %>
            <% if goal.category != "None" and goal.category != "" %>  
                <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />
                <% if current_user == nil %>
                    <a href="/user_session/new?skip_intro=1&after_login_cn=goals&after_login_param_1_name=join_a_team&after_login_param_1_val=1&after_login_param_2_name=goal_id&after_login_param_2_val=<%=goal.id%>">
                <% else %>
                    <a href="/goals?join_a_team=1&goal_id=<%=goal.id%>"> 
                <% end %>
                <strong>Join a Team!!!</strong></a></h3></p>
                <p>(Put me on a team with 3 Others Committed to a "<%=goal.category%>" Goal)</p>
            <% end %>
        <% end %>
        <!-- END Team Section -->            
    </p>     
    </div>
    <!--
    ########################
    END TEAM SECTION
    ########################
    -->


    <%
    if @checkpoint.status == "yes"
    %>

        
      <% if current_user == nil and @checkpoint.goal.publish %>
        <DIV style="border-width:thin; border-style:solid; border-color:#FFFFFF; background-color:#FFFCCC; padding:10px 10px 10px 10px;">        
          <center>
          <strong>
            Celebrate by posting your success!
          </strong>
          <br>
          <table>
          <tr>
          <td valign=top>
            <a name="fb_share" type="button" share_url="<%= server_root_url%>/cheers/1/shared?shared_u=<%= @checkpoint.goal.user.id %>&one_g=<%= @checkpoint.goal.id%>" href="http://www.facebook.com/sharer.php">Share</a><script src="http://static.ak.fbcdn.net/connect.php/js/FB.Share" type="text/javascript"></script>
            </td>
            <td valign=top>
            <a href=http://twitter.com/home?status=My%20<%= session[:site_name]%>%20goal%20progress:%20<%= server_root_url%>/cheers/1/shared?shared_u=<%= @checkpoint.goal.user.id %>&one_g=<%= @checkpoint.goal.id%>><img src='/images/twitter.png' border=0 alt="Tweet this!"/></a>            
          </td>
          </tr>
          </table>
          <br>
          </center>
        </div>
      <% end %>
    <%
    end
    ########################################
    ###### END PRINT WELCOME INFO 
    ########################################
    %>


    <DIV style="border-radius:20px;-moz-border-radius:20px;border-width:none;border-color:#eeeeee;background-color:#ffffff;border-style:solid;padding:10px 10px 10px 10px;margin:10px 10px 10px 10px;width:610px;">
    <p>                
    <div class="container_12">
        <div class="grid_3">
            <%
            #############################################################
            ####      SHOW DAYS STRAIGHT TEXT AND ICON
            #############################################################    
            %>
            <%= @print_days_straight %>
            <%= @print_wheel %>

            <% 
            if @missing_answers_since_start_date == 1 %>            
                <% if current_user == nil %>
                    <a href="/user_session/new?skip_intro=1&after_login_cn=goals&after_login_ca=single&after_login_id=<%= @checkpoint.goal.id %>"><strong><font color=red>Update Missing Checkpoint(s)</font></a></strong>
                <% else %>
                    <a href="goals/single/<%= @checkpoint.goal.id %>"><strong><font color=red>Update Missing Checkpoint(s)</font></a></strong>
                <% end %>
            <% 
            end 

            #############################################################
            ####      END SHOW DAYS STRAIGHT TEXT AND ICON
            #############################################################    
            %>  


            <% 
            totalsize = @checkpoints.size            
            if totalsize > 0
              yes = Checkpoint.find(:all, :conditions => "status = 'yes' and goal_id = '#{@checkpoint.goal.id}'")
              yes_percent = (((yes.size + 0.0) / totalsize)*100).floor 
              %>
              <h3><%= yes_percent %>% Success Rate </h3> 
            <% 
            end 
            %>

        </div>
        <div class="grid_9">
            <% 
            if @checkpoint.goal.status == "start" and @checkpoint.goal.established_on != nil
              ### If we've established the goal, ask if they want it monitored
              if @checkpoint.goal.established_on > @checkpoint.goal.start
              %>
                <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <h1>Congratulations on establishing a new habit!!!</h1>
                <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <b><font color="red">Would you like to keep monitoring this habit?</font></b>
                <!--
                #old link value was: #{session[:return_to_me]}&extend_g=#{@checkpoint.goal.id}"        
                -->
                <%= link_to 'Monitor for another 3 weeks!!!', "#{ server_root_url }/goals/extend_time/#{@checkpoint.goal.id}?u=#{@checkpoint.goal.user.id}" %>
              <%
              end
            end
            %>
        </div>
    </div>













    
    <%
    ####################################################
    ####    MONITORING OPTIONS
    ####################################################
    if @checkpoint.goal.status == "monitor"
      ################################################
      #### OLDER SHORTY STATS
      ################################################
      %>
      <br>
      <% 
      ### If we're within 3 days of the end of the monitoring period, give the option to extend another 3 weeks
      if @checkpoint.goal.stop - dnow < 3
      %>
      <br>
      <b><font color="red">Would you like to keep monitoring this habit?</font></b>
      <br>
      <%= link_to 'Monitor for another 3 weeks!!!', "#{ server_root_url }/goals/extend_time/#{@checkpoint.goal.id}?u=#{@checkpoint.goal.user.id}" %>
      <%  
      end
      ################################################



      ################################################
      #### NEWER ENHANCED STATS
      ################################################

        ### instead of daysgoneby = dnow - @checkpoint.goal.start,
        ### calculate, instead the number of checkpoints that have been created
        @checkpoints_gone_by = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}' and checkin_date >= '#{@checkpoint.goal.start}'")
        daysgoneby = @checkpoints_gone_by.size

          #### START GOAL BOX
        %>
        <DIV style="border-width:thin; border-style:solid; border-color:#FFFFFF; padding:0px 0px 0px 0px;">
        <%
        ### instead of daysgoneby = dnow - goal.start,
        ### calculate, instead the number of checkpoints that have been created
        @checkpoints_gone_by = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}' and checkin_date >= '#{@checkpoint.goal.start}'")
        daysgoneby = @checkpoints_gone_by.size

        ###daysleft = goal.stop - dnow
        daysleft = 21 - daysgoneby

        @checkpoints = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}'")
        totalsize = @checkpoints.size


        daysinarow = 0
        ##count backwards to get the number of yes's in a row
        thestatus = "yes"
        dcheckday = dyesterday
        while thestatus == "yes" do
        @oldercheckpoints = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}' and checkin_date = '#{dcheckday}' and status = 'yes'")
        if @oldercheckpoints.size == 0
          thestatus = "no"
        else
          daysinarow = daysinarow + 1
        end
        dcheckday = dcheckday - 1
        end
        ##update the goal's daysstraight field
        @checkpoint.goal.daysstraight = daysinarow
        @checkpoint.goal.save 
    
        if @checkpoint.goal.established_on.to_s != "1900-01-01" %>
            <img src="/images/ring_buttons21.png" alt="Established Habit" width = 100 border=0/>
        <% end %>
    
        <% if totalsize > 0
          @no = Checkpoint.find(:all, :conditions => "status = 'no' and goal_id = '#{@checkpoint.goal.id}'")
          no_percent = (((@no.size + 0.0) / totalsize)*100).floor  
          @yes = Checkpoint.find(:all, :conditions => "status = 'yes' and goal_id = '#{@checkpoint.goal.id}'")
          yes_percent = (((@yes.size + 0.0) / totalsize)*100).floor 
          @missing = Checkpoint.find(:all, :conditions => "status = 'email sent' and goal_id = '#{@checkpoint.goal.id}'")
          # Convert these Ints into Floats by adding 0.0
          missing = @missing.size + 0.0
          total = totalsize + 0.0
          missing_percent = ((missing / total)*100).floor
          %>
        <% else %>
          <img src="/images/monitor_no_stats.png" alt="No Stats Yet" border=0 />
        <% end %>



        
        <% 
        first_checkpoint = Checkpoint.find(:first, :conditions => "goal_id = #{@checkpoint.goal.id}", :order => "checkin_date asc") 
        if first_checkpoint != nil
            forged_in = @checkpoint.goal.established_on - first_checkpoint.checkin_date
        end

        desired_success_rate = 0
        %>
        <% if @checkpoint.goal.goal_days_per_week != nil %>
            <%
        
            desired_success_rate = ((@checkpoint.goal.goal_days_per_week * 100)/ 7)

        
            ###Calculate number of "yes" answers from Monday through now
            ###   dmonday = ? 
            ###   through dnow

            dmonday = dnow
        
            dnow_minus_1 = dnow - 1
            dnow_minus_2 = dnow - 2
            dnow_minus_3 = dnow - 3
            dnow_minus_4 = dnow - 4
            dnow_minus_5 = dnow - 5
            dnow_minus_6 = dnow - 6

            dnow_dayname = dnow.strftime("%A")
            dnow_minus_1_dayname = dnow_minus_1.strftime("%A")
            dnow_minus_2_dayname = dnow_minus_2.strftime("%A")
            dnow_minus_3_dayname = dnow_minus_3.strftime("%A")
            dnow_minus_4_dayname = dnow_minus_4.strftime("%A")
            dnow_minus_5_dayname = dnow_minus_5.strftime("%A")
            dnow_minus_6_dayname = dnow_minus_6.strftime("%A")
        
            if dnow_dayname == "Monday"
                dmonday = dnow
            end
            if dnow_minus_1_dayname == "Monday"
                dmonday = dnow_minus_1
            end
            if dnow_minus_2_dayname == "Monday"
                dmonday = dnow_minus_2
            end
            if dnow_minus_3_dayname == "Monday"
                dmonday = dnow_minus_3
            end
            if dnow_minus_4_dayname == "Monday"
                dmonday = dnow_minus_4
            end
            if dnow_minus_5_dayname == "Monday"
                dmonday = dnow_minus_5
            end
            if dnow_minus_6_dayname == "Monday"
                dmonday = dnow_minus_6
            end

            @wins_since_monday = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}' and checkin_date >= '#{dmonday}' and status = 'yes'")
            wins_since_monday = @wins_since_monday.size



            ###Calculate number of "yes" answers from last Monday through Sunday
            dlastmonday = dnow - 7
        
            dnow_minus_8 = dnow - 8
            dnow_minus_9 = dnow - 9
            dnow_minus_10 = dnow - 10
            dnow_minus_11 = dnow - 11
            dnow_minus_12 = dnow - 12
            dnow_minus_13 = dnow - 13

            dlastweek_dayname = dlastmonday.strftime("%A")
            dnow_minus_8_dayname = dnow_minus_8.strftime("%A")
            dnow_minus_9_dayname = dnow_minus_9.strftime("%A")
            dnow_minus_10_dayname = dnow_minus_10.strftime("%A")
            dnow_minus_11_dayname = dnow_minus_11.strftime("%A")
            dnow_minus_12_dayname = dnow_minus_12.strftime("%A")
            dnow_minus_13_dayname = dnow_minus_13.strftime("%A")
        
            if dlastweek_dayname == "Monday"
                dlastmonday = dlastmonday
            end
            if dnow_minus_8_dayname == "Monday"
                dlastmonday = dnow_minus_8
            end
            if dnow_minus_9_dayname == "Monday"
                dlastmonday = dnow_minus_9
            end
            if dnow_minus_10_dayname == "Monday"
                dlastmonday = dnow_minus_10
            end
            if dnow_minus_11_dayname == "Monday"
                dlastmonday = dnow_minus_11
            end
            if dnow_minus_12_dayname == "Monday"
                dlastmonday = dnow_minus_12
            end
            if dnow_minus_13_dayname == "Monday"
                dlastmonday = dnow_minus_13
            end
            ###############################
            dlastsunday = dnow - 1
        
            dnow_minus_2 = dnow - 2
            dnow_minus_3 = dnow - 3
            dnow_minus_4 = dnow - 4
            dnow_minus_5 = dnow - 5
            dnow_minus_6 = dnow - 6
            dnow_minus_7 = dnow - 7

            dlastsunday_dayname = dlastsunday.strftime("%A")
            dnow_minus_2_dayname = dnow_minus_2.strftime("%A")
            dnow_minus_3_dayname = dnow_minus_3.strftime("%A")
            dnow_minus_4_dayname = dnow_minus_4.strftime("%A")
            dnow_minus_5_dayname = dnow_minus_5.strftime("%A")
            dnow_minus_6_dayname = dnow_minus_6.strftime("%A")
            dnow_minus_7_dayname = dnow_minus_7.strftime("%A")
        
            if dlastsunday_dayname == "Sunday"
                dlastsunday = dlastsunday
            end
            if dnow_minus_2_dayname == "Sunday"
                dlastsunday = dnow_minus_2
            end
            if dnow_minus_3_dayname == "Sunday"
                dlastsunday = dnow_minus_3
            end
            if dnow_minus_4_dayname == "Sunday"
                dlastsunday = dnow_minus_4
            end
            if dnow_minus_5_dayname == "Sunday"
                dlastsunday = dnow_minus_5
            end
            if dnow_minus_6_dayname == "Sunday"
                dlastsunday = dnow_minus_6
            end
            if dnow_minus_7_dayname == "Sunday"
                dlastsunday = dnow_minus_7
            end            

            ##################
            @wins_last_week = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}' and checkin_date >= '#{dlastmonday}' and checkin_date <= '#{dlastsunday}' and status = 'yes'")
            wins_last_week = @wins_last_week.size

            last_week_result = ""
            last_week_margin = wins_last_week - @checkpoint.goal.goal_days_per_week
            last_week_image = "thumbs_up.png"
            if last_week_margin == 0 
                last_week_result = "You met your goal!"
            end
            if last_week_margin < 0 
                last_week_result = "You fell short by #{last_week_margin * (-1)}"
                last_week_image = "thumbs_down.png"
            end
            if last_week_margin > 0 
                last_week_result = "You exceeded your goal by #{last_week_margin}!"
            end
            %>
            <br>

            <DIV style="font-size:16px; border-width:thin; border-left-style:none; border-right-style:none; border-top-style:dashed; border-bottom-style:dashed; border-color:#CCCCCC; background-color:#FFFFCC;  padding:10px 10px 10px 10px;">  

            <strong><%= wins_since_monday %> 
            <% if wins_since_monday == 1 %>
            Win
            <% else %>
            Wins
            <% end %>
             so far this week ... your goal is <%= @checkpoint.goal.goal_days_per_week %> total!
             </strong>
            </div>
        
            <br>
            <br>
            <img src="/images/<%= last_week_image %>" width=20 border=0/>
            <strong>Last Week:</strong> <%= wins_last_week %> Wins ... <%= last_week_result %> 
        <% end %>
        <% if @checkpoint.goal.established_on.to_s == "1900-01-01" %>
            <br>
            <br>

            <% if desired_success_rate > 0 %>
                <br>
                <% if yes_percent >= desired_success_rate %>
                    <img src="/images/thumbs_up.png" width=20 border=0/>
                    <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
                    <br>
                    <strong>This is good, since</strong>
                <% else 
                    %>
                    <img src="/images/thumbs_down.png" width=20 border=0/>
                    <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
                    <br>
                    <strong>Keep working at it</strong>
                <% end %>
                , since your goal is to reach <%= desired_success_rate %>%*!
            <% else %>
                <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
            <% end %>
        <% else %>
            <%
            ####################################################
            ####    SHOW STATS
            ####################################################
            @checkpoints = Checkpoint.find(:all, :conditions => "goal_id = '#{@checkpoint.goal.id}'")
            totalsize = @checkpoints.size
            if totalsize > 0
              %>
              <h3>You're succeeding <%= @yes_percent %>% of the time.</h3>
              <p>(<%= @yes.size %> yes, <%= @no.size %> no, <%= @missing.size %> no reply of <%= totalsize %> Past Checkpoints )</p>
            <% 
            else 
            %>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              no stats yet
            <% 
            end 
            ####################################################
            ####    END CALCULATE STATS
            ####################################################
            %>
        <% end %>
        <br>
        <br>
        <br>
        <% if desired_success_rate > 0 %>
            <em>
            *<%= desired_success_rate %>% = <%= @checkpoint.goal.goal_days_per_week %> days out of 7 per week
            <br>
            "This Week" is since Monday <%= dmonday %>
            <br>
            "Last Week" is Monday <%= dlastmonday %> through Sunday <%= dlastsunday %>
            </em>
        <% end %>


        </div>
        <% #################   END GOAL BOX ############### %>
    <%
    end


    ####################################################
    ####    END MONITORING OPTIONS
    ####################################################
    %>







    </div>


    <DIV style="border-radius:20px;-moz-border-radius:20px;border-width:medium;border-color:#eeeeee;background-color:#ffffff;border-style:solid;padding:10px 10px 10px 10px;margin:10px 10px 10px 10px;width:610px;">
    <p>                

    <%
    ####################################################
    ####    COMMENTS FORM
    #################################################### 
    form_for @checkpoint, :url => { :action => "update" } do |f| %>
      <%= f.error_messages %>
      <br>
      <h3>Comments (Optional)</h3>
      <%= f.text_area :comment, :cols => 40, :rows => 2 %><br />
      <p>Visible to others only if your goal is "shared" with other users</p>
      <% if params[:return_to_url]
        session[:return_to_url] = params[:return_to_url]
      end 
      %>
      
      <%= submit_tag 'Save Comment' %>
    <% 
    end 
    ####################################################
    ####    END COMMENTS FORM
    #################################################### 
    %>
    </p>
    </div>







      
      



    <%
    ####################################################################
    ###   LOGIN LINKS, CATEGORY WINNERS LINKS
    ####################################################################
    %>
    <br>
    <br>
    <% if !current_user %>
      <hr><br><h3><strong><center><%= link_to "Log in", new_user_session_path + "?skip_intro=1" %>  to view all of your goals and stats</center></strong></h3><br><hr><br><br><br>
        <br>
        <br>
        <h3>Who's got the longest winning streak in the <a href='<%= session[:current_page] %>&show_winners=1'>"<%= @checkpoint.goal.category %>" Category?</a></h3>
    <% end %>
    <br>
    <br>
    <% 
    ####################################################################
    ###   END LOGIN LINKS, CATEGORY WINNERS LINKS
    ####################################################################
        
  #### END DON'T SHOW CATEGORY WINNERS
  end 
  %>
  
  <%
### end LEGIT URL
end
%>  
