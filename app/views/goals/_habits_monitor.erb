<% 
#begin
%>

  <%
  ### GET DATE NOW ###
  jump_forward_days = 0  
  dnow = get_dnow + jump_forward_days
  dyesterday = dnow - 1
  ######
  @my_monitor_goals.each do |goal|


    if params[:restart_goal_id] == goal.id.to_s
        goal.restart_my_goal_at_day_1
    end
    %>


  <p />
  <div />
  
<div class="clear"></div>
<DIV style="border-radius:20px;-moz-border-radius:20px;border-width:thin;border-color:#eeeeee;background-color:#ffffff;border-style:solid;padding:10px 10px 10px 10px;width:900px;">

<div class="container_12">


    <h3><%= link_to_function ("..." + goal.title) {
     |page| page.visual_effect :toggle_appear, "goal_details#{goal.id}" 
    } 
    %></h3>


    <%
    if goal.is_active
        next_email = goal.date_next_checkin_email_will_be_sent.strftime("%A")
        next_action = goal.date_next_to_take_action.strftime("%A")

        if goal.user.dtoday == goal.date_created
        %>
            <h5>
            <%= next_action %> is your next day to work on this, so a check-in email will arrive early on <%= next_email %> morning.
            <br>(So that you have until midnight on <%= next_action %> to succeed.)
            </h5>
        <%
        else
            if !goal.every_day
            %>
                <h5>
                <%= next_action %> is your next day to work on this 
                <br>
                (A check-in email will arrive early on <%= next_email %> morning.)
                </h5>            
            <%
            else
                if goal.user.dtoday == goal.start
                %>
                <h5>
                Today is your new "Day 1" to work on this, so a check-in email will arrive early tomorrow morning.
                <br>(So that you have until midnight tonight to succeed.)
                </h5>
                <%
                end
            end
        end
    else
    %>
        <h5>
        This goal has "gone stale" due to lack of activity. (Email checkpoints are no longer being sent.) <a href="/goals?restart_goal_id=<%= goal.id%>">Start again at Day 1.</a>
        </h5>
    <%
    end
    %>


    <%
    if params[:goal_id] == goal.id.to_s or params[:start_fire_goal_id] == goal.id.to_s
    %>
        <div id="goal_details<%= goal.id %>" style="background-color:#eeeeee;width:800px;">
    <%
    else
    %>
        <div id="goal_details<%= goal.id %>" style="display:none;background-color:#eeeeee;width:800px;">
    <%
    end
    %>

      
      <%= link_to 'Options', edit_goal_path(goal) %> 
      • <a href="/goals/single/<%= goal.id %>" >My History</a>
      • <%= link_to 'Delete', goal, :confirm => 'Are you sure you want to delete this goal?', :method => :delete %>
      
    <div class="grid_12">
    <div class="grid_3 alpha">

        <%
        totalsize = goal.checkpoints.size


    
        if goal.established_on.to_s != "1900-01-01" 
        %>
            <img src="/images/ring_buttons21.png" alt="Established Habit" width = 100 border=0/>
        <% 
        end
        %>
    
    
        <%
      
          ### If we're within 3 days of the end of the monitoring period, give the option to extend another 3 weeks
          if goal.stop - dnow < 3
          %>
            <p><font color=red>Monitoring ends <br> on <%=h goal.stop %></font>
            <br><%= link_to 'Extend 3 weeks?', "goals/extend_time/#{goal.id}" %>
          <%  
          end
          %>
    
    
        <% 
        yes_percent = 0
        if totalsize > 0
          @no = Checkpoint.find(:all, :conditions => "status = 'no' and goal_id = '#{goal.id}'")
          no_percent = (((@no.size + 0.0) / totalsize)*100).floor  
          @yes = Checkpoint.find(:all, :conditions => "status = 'yes' and goal_id = '#{goal.id}'")
          yes_percent = (((@yes.size + 0.0) / totalsize)*100).floor 
          @missing = Checkpoint.find(:all, :conditions => "status = 'email sent' and goal_id = '#{goal.id}'")
          # Convert these Ints into Floats by adding 0.0
          missing = @missing.size + 0.0
          total = totalsize + 0.0
          missing_percent = ((missing / total)*100).floor
          %>
        <% 
        else 
        %>
          <img src="/images/monitor_no_stats.png" alt="No Stats Yet" border=0 />
        <% 
        end 
        %>

    </div>


    <div class="grid_9 omega">

    <DIV style="border-radius:20px;-moz-border-radius:20px;border-width:none;border-color:#eeeeee;background-color:#fffff;border-style:solid;padding:10px 10px 10px 10px;margin:10px 10px 10px 10px;width:610px;">


    <br>
    <% if goal.status != 'hold' and goal.successful_days_in_a_row > 0  and goal.successful_days_in_a_row < 9999 %>
      <strong>Days in a row: <%= goal.successful_days_in_a_row %></strong>      
    <% end %>

    <% 
    first_checkpoint = Checkpoint.find(:first, :conditions => "goal_id = #{goal.id}", :order => "checkin_date asc") 
    if first_checkpoint != nil
        forged_in = goal.established_on - first_checkpoint.checkin_date
    end

    desired_success_rate = 0
    %>
    <% if goal.goal_days_per_week != nil %>
        <%
        
        desired_success_rate = ((goal.goal_days_per_week * 100)/ 7)

        
        ###Calculate number of "yes" answers from Monday through now
        ###   dmonday = ? 
        ###   through dnow

        dmonday = dnow
        
        dnow_minus_1 = dnow - 1
        dnow_minus_2 = dnow - 2
        dnow_minus_3 = dnow - 3
        dnow_minus_4 = dnow - 4
        dnow_minus_5 = dnow - 5
        dnow_minus_6 = dnow - 6

        dnow_dayname = dnow.strftime("%A")
        dnow_minus_1_dayname = dnow_minus_1.strftime("%A")
        dnow_minus_2_dayname = dnow_minus_2.strftime("%A")
        dnow_minus_3_dayname = dnow_minus_3.strftime("%A")
        dnow_minus_4_dayname = dnow_minus_4.strftime("%A")
        dnow_minus_5_dayname = dnow_minus_5.strftime("%A")
        dnow_minus_6_dayname = dnow_minus_6.strftime("%A")
        
        if dnow_dayname == "Monday"
            dmonday = dnow
        end
        if dnow_minus_1_dayname == "Monday"
            dmonday = dnow_minus_1
        end
        if dnow_minus_2_dayname == "Monday"
            dmonday = dnow_minus_2
        end
        if dnow_minus_3_dayname == "Monday"
            dmonday = dnow_minus_3
        end
        if dnow_minus_4_dayname == "Monday"
            dmonday = dnow_minus_4
        end
        if dnow_minus_5_dayname == "Monday"
            dmonday = dnow_minus_5
        end
        if dnow_minus_6_dayname == "Monday"
            dmonday = dnow_minus_6
        end

        @wins_since_monday = Checkpoint.find(:all, :conditions => "goal_id = '#{goal.id}' and checkin_date >= '#{dmonday}' and status = 'yes'")
        wins_since_monday = @wins_since_monday.size



        ###Calculate number of "yes" answers from last Monday through Sunday
        dlastmonday = dnow - 7
        
        dnow_minus_8 = dnow - 8
        dnow_minus_9 = dnow - 9
        dnow_minus_10 = dnow - 10
        dnow_minus_11 = dnow - 11
        dnow_minus_12 = dnow - 12
        dnow_minus_13 = dnow - 13

        dlastweek_dayname = dlastmonday.strftime("%A")
        dnow_minus_8_dayname = dnow_minus_8.strftime("%A")
        dnow_minus_9_dayname = dnow_minus_9.strftime("%A")
        dnow_minus_10_dayname = dnow_minus_10.strftime("%A")
        dnow_minus_11_dayname = dnow_minus_11.strftime("%A")
        dnow_minus_12_dayname = dnow_minus_12.strftime("%A")
        dnow_minus_13_dayname = dnow_minus_13.strftime("%A")
        
        if dlastweek_dayname == "Monday"
            dlastmonday = dlastmonday
        end
        if dnow_minus_8_dayname == "Monday"
            dlastmonday = dnow_minus_8
        end
        if dnow_minus_9_dayname == "Monday"
            dlastmonday = dnow_minus_9
        end
        if dnow_minus_10_dayname == "Monday"
            dlastmonday = dnow_minus_10
        end
        if dnow_minus_11_dayname == "Monday"
            dlastmonday = dnow_minus_11
        end
        if dnow_minus_12_dayname == "Monday"
            dlastmonday = dnow_minus_12
        end
        if dnow_minus_13_dayname == "Monday"
            dlastmonday = dnow_minus_13
        end
        ###############################
        dlastsunday = dnow - 1
        
        dnow_minus_2 = dnow - 2
        dnow_minus_3 = dnow - 3
        dnow_minus_4 = dnow - 4
        dnow_minus_5 = dnow - 5
        dnow_minus_6 = dnow - 6
        dnow_minus_7 = dnow - 7

        dlastsunday_dayname = dlastsunday.strftime("%A")
        dnow_minus_2_dayname = dnow_minus_2.strftime("%A")
        dnow_minus_3_dayname = dnow_minus_3.strftime("%A")
        dnow_minus_4_dayname = dnow_minus_4.strftime("%A")
        dnow_minus_5_dayname = dnow_minus_5.strftime("%A")
        dnow_minus_6_dayname = dnow_minus_6.strftime("%A")
        dnow_minus_7_dayname = dnow_minus_7.strftime("%A")
        
        if dlastsunday_dayname == "Sunday"
            dlastsunday = dlastsunday
        end
        if dnow_minus_2_dayname == "Sunday"
            dlastsunday = dnow_minus_2
        end
        if dnow_minus_3_dayname == "Sunday"
            dlastsunday = dnow_minus_3
        end
        if dnow_minus_4_dayname == "Sunday"
            dlastsunday = dnow_minus_4
        end
        if dnow_minus_5_dayname == "Sunday"
            dlastsunday = dnow_minus_5
        end
        if dnow_minus_6_dayname == "Sunday"
            dlastsunday = dnow_minus_6
        end
        if dnow_minus_7_dayname == "Sunday"
            dlastsunday = dnow_minus_7
        end            

        ##################
        @wins_last_week = Checkpoint.find(:all, :conditions => "goal_id = '#{goal.id}' and checkin_date >= '#{dlastmonday}' and checkin_date <= '#{dlastsunday}' and status = 'yes'")
        wins_last_week = @wins_last_week.size

        last_week_result = ""
        last_week_margin = wins_last_week - goal.goal_days_per_week
        last_week_image = "thumbs_up.png"
        if last_week_margin == 0 
            last_week_result = "You met your goal!"
        end
        if last_week_margin < 0 
            last_week_result = "You fell short by #{last_week_margin * (-1)}"
            last_week_image = "thumbs_down.png"
        end
        if last_week_margin > 0 
            last_week_result = "You exceeded your goal by #{last_week_margin}!"
        end
        %>
        <br>

        
    <% end %>
    <br>
    <br>
    
    
    <h4><%= link_to_function ("Show Stats") {
     |page| page.visual_effect :toggle_appear, "stats_#{goal.id}" 
    } 
    %></h4>
    <div id="stats_<%= goal.id %>" style="display:none;"> 
        

        <DIV class = "notice">  
            <strong>This Week: <%= wins_since_monday %> 
            <% if wins_since_monday == 1 %>
            Win
            <% else %>
            Wins
            <% end %>
            so far ... your goal is <%= goal.goal_days_per_week %> per week
            </strong>
        </div>
        
        <img src="/images/<%= last_week_image %>" width=20 border=0/>
        <strong>Last Week:</strong> <%= wins_last_week %> Wins ... <%= last_week_result %> 

        <% if desired_success_rate > 0 %>
            <br>
            <% if yes_percent >= desired_success_rate %>
                <img src="/images/thumbs_up.png" width=20 border=0/>
                <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
                <br>
                <strong>This is good, since</strong>
            <% else 
                %>
                <img src="/images/thumbs_down.png" width=20 border=0/>
                <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
                <br>
                <strong>Keep working at it</strong>
            <% end %>
            , since your goal is to reach <%= desired_success_rate %>%*!
        <% else %>
            <strong>Overall,</strong> you're succeeded an average of <%= yes_percent%>% of the relevant days.
        <% end %>

        <% if desired_success_rate > 0 %>
            <h6>
            *<%= desired_success_rate %>% = <%= goal.goal_days_per_week %> days out of 7 per week
            <br>
            "This Week" is since Monday <%= dmonday %>
            <br>
            "Last Week" is Monday <%= dlastmonday %> through Sunday <%= dlastsunday %>
            </h6>
        <% end %>

    </div>






            <% if session[:site_name] == "habitforge" %>
            <!-- 
            COACH!!!
            START render the partial _coach.erb file from the goal views 
            <h4>link_to_function ("Click for Coaching Options") {
             |page| page.visual_effect :toggle_appear, "coach_#{goal.id}" 
            } 
            </h4>
            <div id="coach_= goal.id " style="display:none;padding:10px 10px 10px 10px;margin:10px 10px 10px 10px;">
              

              @goal = goal 
              render :partial => "goals/coach", :locals => { :coach => @goal }  
            </div>
            END render the partial _coach.erb file from the goal views 
            -->
            <% end %>




        



          
            <!-- START Team Section -->

            <div id="team_<%= @goal.id %>">                    
            
            <p>      
            <% if goal.team != nil %>      
                <%
                  @team_goals = Goal.find(:all, :conditions => "team_id = '#{goal.team_id}'")
                  if @team_goals.size < 2
                      %>
                      <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />We're recruiting other people for your team.
                      </h3></p>
                      <br>
                      <%
                  else
                      has_percentage = 0
                      total_percentage = 0
                      average_percentage = 0
                      for team_goal in @team_goals
                          if team_goal.success_rate_percentage != nil
                              has_percentage = has_percentage + 1
                              total_percentage = total_percentage + team_goal.success_rate_percentage
                          end
                      end
                      if has_percentage > 0
                          average_percentage = total_percentage / has_percentage
                          %>
                          <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />My Team's Success Rate is <%= average_percentage %>% 
                          | <a href="popupex.html" onclick="return popitup('team_rules.html')">Team Rules</a>
                          | <a href="/goals?quit_a_team=1&goal_id=<%=goal.id%>">Quit this team</a></h3></p>

                          <br>
                          <%
                      else
                          %>
                          <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />My Team</h3></p>
                          <br>
                          <%                  
                      end
                  end
                  for team_goal in @team_goals
                    %>
                    <% if team_goal.user.id != current_user.id %>
                        <p><img src="/images/comment_user_add_32.png" border=0 /> <a href="/tomessages/new?to_id=<%= team_goal.user.id %>" >Send <%= team_goal.user.first_name %> a Message about <%= team_goal.response_question %></a>
                        • 
                        <% if team_goal.success_rate_percentage != nil %>
                             Succeeding <%= team_goal.success_rate_percentage %>% of the last
                        <% end %>
                        <% if team_goal.days_into_it != nil %>
                            <%= team_goal.days_into_it %> days
                        <% end %>

                        <% if team_goal.daysstraight != nil and team_goal.daysstraight != 9999 %>
                            has done it <%= team_goal.daysstraight %> days in a row
                        <% end %>

                        <% if team_goal.laststatusdate != nil and team_goal.laststatus != nil %>
                        <% else %>              
                             (has not yet checked in)
                        <% end %> 
                        </p>
                    <% end %>            
                    <%
                  end
                  %> 
            <% end %>

            <% if goal.team == nil %>
                <% if goal.category == "None" or goal.category == "" %>  
                    <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 />Join a Team!</h3>
                    <h5><%= link_to "Choose a category", edit_goal_path(goal) %>, and you can Share Stats with 3 people who have a similar goal.</h5>        
                    </p>
                <% else %>
                    <p><h3><img src="/images/user-group-icon.png" height="30px" border=0 /><a href="/goals?join_a_team=1&goal_id=<%=goal.id%>"> <strong>Join a Team!!!</strong></a></h3></p>
                    <p>(Put me on a team with 3 Others Committed to a "<%=goal.category%>" Goal)</p>
                <% end %>
            <% end %>
            <br>
            <br>
            </p>            

            </div>  
            <!-- END Team Section -->            



        <div id="extra_<%= goal.id %>" >
            
            <p>                

            <br>

            <DIV style="border-radius:20px;-moz-border-radius:20px;border-width:medium;border-color:#eeeeee;background-color:#eeeeee;border-style:none;padding:10px 10px 10px 10px;margin:10px 10px 10px 10px;width:610px;">
            <% 
            invites_sent = Cheer.find(:all, :conditions => "goal_id = '#{goal.id}'")
            if invites_sent.size > 0
            %>
                <br>
                <h3>Who's Watching?</h3>
                <% 
                invites_sent.each do |cheer|
                    invited_user = User.find(:first, :conditions => "email = '#{cheer.email}'")
                    if invited_user
                    %>
                        <img src="/images/lightbulb_32.png" height="20px" border=0 />                         
                        <%
                        show_delete_icon = true
                        if goal.coachgoal != nil
                            if invited_user.id == goal.coachgoal.coach.user.id
                                show_delete_icon = false
                            end
                        end
                        if show_delete_icon
                            %>
                            <%= link_to '<img src="/images/close_32.png" height="20px" border=0 alt="Delete" />', cheer, :confirm => 'Are you sure you want this person to stop following this goal?', :method => :delete %>
                            <%
                        end
                        %>
                        <%= invited_user.first_name %> is watching.
                        <a href="/tomessages/new?to_id=<%= invited_user.id %>" >Send <%= invited_user.first_name %> a Message</a>

                    <%
                    else
                    %>
                        <img src="/images/lightbulb_off_32.png" height="20px" border=0 />
                        <%= link_to '<img src="/images/close_32.png" height="20px" border=0 alt="Delete" />', cheer, :confirm => 'Are you sure you want this person to stop following this goal?', :method => :delete %>                            
                        <%= cheer.email %> (waiting for them to sign up)
                    <%
                    end
                    %>
                    <br>
                <%
                end
                %>
                <h3><img src="/images/user_add_32.png" height="30px" border=0 /><%= link_to "Invite another friend to follow your progress", :controller => "goals", :action => "invite_a_friend_to_track", :id => goal.id%></h3>
                
            
            <%
            else
            %>
                <h3><img src="/images/user_add_32.png" height="30px" border=0 /><%= link_to "Invite a friend to follow your progress", :controller => "goals", :action => "invite_a_friend_to_track", :id => goal.id%></h3>
            <%
            end
            %>
            </p>
            </div>

            <br>
            

            <% if session[:site_name] == "habitforge" %>
            <!-- 
            FIRE!!!
            START render the partial _fire.erb file from the goal views 
            -->
              <% @goal = goal %>
              <%= render :partial => "goals/fire", :locals => { :fire => @goal }  %>
            <!-- 
            END render the partial _fire.erb file from the goal views 
            -->
            <% end %>

        </div>



        </div>


        </div>


    </div>


    </div>



    </div>

   </div>



    <% if request.env['HTTP_USER_AGENT'] =~ /[^\(]*[^\)]Firefox\// %>
        </div>
    <% else %>
        <% if request.env['HTTP_USER_AGENT'] =~ /[^\(]*[^\)]Safari\// %>
            </div>
        <% end %>
    <% end %>

    <% #################   END GOAL BOX ############### %>

    <br />

  <% 
  end 
  %>

  <br />
<%
#rescue
#  <br>
#  <p><font color=red>Something went wrong. Go back to the <a href="http://habitforge.com">home page</a> and try again, or <a href="mailto:support@habitforge.com">Contact Support</a></font></p>
#  </div>

%>
<%
#end
%>
